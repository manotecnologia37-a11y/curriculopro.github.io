
import React, { useState, useEffect } from 'react';
import { 
  ResumeData, 
  PersonalInfo, 
  Experience, 
  Education, 
  Skill, 
  Project,
  TemplateId
} from './types';
import Header from './components/Header';
import PersonalInfoForm from './components/Form/PersonalInfoForm';
import SummaryForm from './components/Form/SummaryForm';
import ExperienceForm from './components/Form/ExperienceForm';
import EducationForm from './components/Form/EducationForm';
import SkillsForm from './components/Form/SkillsForm';
import ProjectsForm from './components/Form/ProjectsForm';
import TemplateSelector from './components/Form/TemplateSelector';
import AutoFillForm from './components/Form/AutoFillForm';
import ResumePreview from './components/ResumePreview';

type TabId = 'autofill' | 'templates' | 'info' | 'summary' | 'experience' | 'education' | 'skills' | 'projects';

const STORAGE_KEY = 'ai_resume_pro_data';

const INITIAL_STATE: ResumeData = {
  personalInfo: {
    fullName: '',
    email: '',
    phone: '',
    location: '',
    linkedin: '',
    portfolio: '',
    jobTitle: '',
  },
  summary: '',
  experiences: [],
  educations: [],
  skills: [],
  projects: [],
  themeColor: '#1e3a8a',
  templateId: 'professional',
};

const App: React.FC = () => {
  const [data, setData] = useState<ResumeData>(() => {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      try {
        return JSON.parse(saved);
      } catch (e) {
        console.error("Erro ao carregar dados salvos:", e);
        return INITIAL_STATE;
      }
    }
    return INITIAL_STATE;
  });

  const [activeTab, setActiveTab] = useState<TabId>('autofill');
  const [isDownloading, setIsDownloading] = useState(false);

  useEffect(() => {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }, [data]);

  const updatePersonalInfo = (info: Partial<PersonalInfo>) => {
    setData(prev => ({ ...prev, personalInfo: { ...prev.personalInfo, ...info } }));
  };

  const updateSummary = (summary: string) => {
    setData(prev => ({ ...prev, summary }));
  };

  const updateExperiences = (experiences: Experience[]) => {
    setData(prev => ({ ...prev, experiences }));
  };

  const updateEducations = (educations: Education[]) => {
    setData(prev => ({ ...prev, educations }));
  };

  const updateSkills = (skills: Skill[]) => {
    setData(prev => ({ ...prev, skills }));
  };

  const updateProjects = (projects: Project[]) => {
    setData(prev => ({ ...prev, projects }));
  };

  const updateThemeColor = (themeColor: string) => {
    setData(prev => ({ ...prev, themeColor }));
  };

  const updateTemplate = (templateId: TemplateId) => {
    setData(prev => ({ ...prev, templateId }));
  };

  const handleAutoFillData = (parsedData: any) => {
    setData(prev => ({
      ...prev,
      personalInfo: {
        ...prev.personalInfo,
        ...(parsedData.personalInfo || {})
      },
      summary: parsedData.summary || prev.summary,
      experiences: parsedData.experiences?.map((e: any) => ({ ...e, id: crypto.randomUUID() })) || prev.experiences,
      educations: parsedData.educations?.map((e: any) => ({ ...e, id: crypto.randomUUID() })) || prev.educations,
      skills: parsedData.skills?.map((s: any) => ({ ...s, id: crypto.randomUUID() })) || prev.skills,
    }));
    setActiveTab('info');
  };

  const resetData = () => {
    if (window.confirm("Tem certeza que deseja apagar todos os dados e começar do zero?")) {
      setData(INITIAL_STATE);
      localStorage.removeItem(STORAGE_KEY);
      setActiveTab('autofill');
    }
  };

  const handleDownloadPDF = async () => {
    const element = document.querySelector('.resume-preview');
    if (!element) return;

    setIsDownloading(true);
    
    // Configurações do html2pdf
    const opt = {
      margin: 0,
      filename: `curriculo_${data.personalInfo.fullName.replace(/\s+/g, '_').toLowerCase()}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { 
        scale: 2, 
        useCORS: true,
        letterRendering: true,
        logging: false
      },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    try {
      // @ts-ignore
      await html2pdf().set(opt).from(element).save();
    } catch (error) {
      console.error("Erro ao gerar PDF:", error);
      alert("Houve um erro ao gerar o download. Tente usar o botão de Imprimir.");
    } finally {
      setIsDownloading(false);
    }
  };

  return (
    <div className="min-h-screen bg-slate-50 flex flex-col">
      <Header 
        className="no-print" 
        onTemplatesClick={() => setActiveTab('templates')}
      />
      
      <main className="flex-1 container mx-auto p-4 md:p-8 grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div className="no-print bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden flex flex-col h-[85vh]">
          <div className="flex bg-slate-50 border-b overflow-x-auto scrollbar-hide">
            {[
              { id: 'autofill', label: 'Magia IA', icon: 'fa-wand-sparkles' },
              { id: 'templates', label: 'Modelos', icon: 'fa-layer-group' },
              { id: 'info', label: 'Info', icon: 'fa-user' },
              { id: 'summary', label: 'Resumo', icon: 'fa-align-left' },
              { id: 'experience', label: 'Experiência', icon: 'fa-briefcase' },
              { id: 'education', label: 'Educação', icon: 'fa-graduation-cap' },
              { id: 'skills', label: 'Habilidades', icon: 'fa-tools' },
              { id: 'projects', label: 'Projetos', icon: 'fa-folder-open' },
            ].map((tab) => (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id as any)}
                className={`px-6 py-4 flex items-center gap-2 font-medium transition-all whitespace-nowrap border-b-2 ${
                  activeTab === tab.id 
                    ? 'border-indigo-600 text-indigo-600 bg-white' 
                    : 'border-transparent text-slate-500 hover:text-slate-700 hover:bg-slate-100'
                }`}
              >
                <i className={`fas ${tab.icon} text-sm`}></i>
                {tab.label}
              </button>
            ))}
          </div>

          <div className="flex-1 overflow-y-auto p-6 scroll-smooth">
            {activeTab === 'autofill' && (
              <AutoFillForm onDataParsed={handleAutoFillData} />
            )}
            {activeTab === 'templates' && (
              <TemplateSelector 
                selectedId={data.templateId} 
                onSelect={updateTemplate} 
              />
            )}
            {activeTab === 'info' && (
              <PersonalInfoForm 
                data={data.personalInfo} 
                onChange={updatePersonalInfo} 
                themeColor={data.themeColor}
                onThemeChange={updateThemeColor}
              />
            )}
            {activeTab === 'summary' && (
              <SummaryForm 
                summary={data.summary} 
                jobTitle={data.personalInfo.jobTitle}
                onChange={updateSummary} 
              />
            )}
            {activeTab === 'experience' && (
              <ExperienceForm 
                experiences={data.experiences} 
                jobTitle={data.personalInfo.jobTitle}
                onChange={updateExperiences} 
              />
            )}
            {activeTab === 'education' && (
              <EducationForm 
                educations={data.educations} 
                onChange={updateEducations} 
              />
            )}
            {activeTab === 'skills' && (
              <SkillsForm 
                skills={data.skills} 
                onChange={updateSkills} 
              />
            )}
            {activeTab === 'projects' && (
              <ProjectsForm 
                projects={data.projects} 
                onChange={updateProjects} 
              />
            )}
          </div>
          
          <div className="p-4 border-t bg-slate-50 flex justify-between items-center gap-4">
             <button 
                onClick={resetData}
                title="Limpar tudo"
                className="text-slate-400 hover:text-red-500 transition-colors p-2"
             >
               <i className="fas fa-trash-can"></i>
             </button>
             <div className="flex-1 flex justify-end gap-2">
                <button 
                    onClick={handleDownloadPDF}
                    disabled={isDownloading}
                    className="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg font-semibold flex items-center gap-2 transition-all shadow-md disabled:opacity-50"
                >
                  <i className={`fas ${isDownloading ? 'fa-spinner fa-spin' : 'fa-download'}`}></i>
                  {isDownloading ? 'Gerando...' : 'Download PDF'}
                </button>
                <button 
                    onClick={() => window.print()}
                    className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-semibold flex items-center gap-2 transition-all shadow-md"
                >
                  <i className="fas fa-print"></i>
                  Imprimir
                </button>
             </div>
          </div>
        </div>

        <div className="flex flex-col items-center preview-container">
          <div className="sticky top-8 w-full">
            <h2 className="text-sm font-bold text-slate-400 uppercase tracking-widest mb-4 no-print flex items-center gap-2">
              <i className="fas fa-eye"></i> Visualização
            </h2>
            <ResumePreview data={data} />
          </div>
        </div>
      </main>
      
      <footer className="no-print bg-white border-t p-6 text-center text-slate-500 text-sm mt-8">
        © 2024 AI Resume Pro Builder. Criado com React e Gemini API.
      </footer>
    </div>
  );
};

export default App;
